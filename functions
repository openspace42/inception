#!/usr/bin/env bash

### openspace synthia bootstrap framework v0.3.0 [https://github.com/openspace42/synthia]

os_dna_version="0.3.1"

################################################################################

synthia-define_vars() {

	############################################################################
	#################### Insert your initial variables here ####################
	############################################################################

	export proj_name="inception"
	export author_name="openspace42"
	export git_host="https://github.com"

	### Set this to `y` if your project stores no data on end users' machines that could go lost during a re-install or update
	export skip_install_time_backup="y"

	### Set this to the directory that has the most impactful size when performing a backup [such as `/var/www/` for nginx-related projects]
	export backup_ref_dir="/path/to/ref/dir"

	############################################################################
	############################################################################
	############################################################################

	### Do NOT edit the following line

	dna-define_vars

	############################################################################
	################## Insert your additional variables here ###################
	############################################################################

	############################################################################
	############################################################################
	############################################################################

}

################################################################################

synthia-define_formatting() {

	r=$'\e[1;31m'
	g=$'\e[1;32m'
	l=$'\e[1;34m'
	m=$'\e[1;35m'
	y=$'\e[1;33m'
	o=$'\e[38;5;208m'
	c=$'\e[1;36m'
	n=$'\e[1;39m'
	x=$'\e[0m'
	b=$'\033[1m'

}

synthia-check_root() {

	if [[ $EUID -ne 0 ]]
	then
		echo "${r-}${b-}This script must be run as root.${x-}"
		echo
		echo "${b-}Exiting...${x-}"
		echo
		exit 1
	fi

}

synthia-download_dna() {

	clone_host="https://github.com"
	clone_author="openspace42"
	clone_name="dna"

	clone_base_dir="/root/${clone_author}"
	clone_dir="${clone_base_dir}/${clone_name}"

	mkdir -p "${clone_base_dir}"

	if [ -d "${clone_dir}" ]
	then
		rm -r "${clone_dir:?}"
	fi

	( cd "${clone_base_dir}" && git clone "${clone_host}/${clone_author}/${clone_name}" && cd "$clone_name" && \
		if [ ! "${custom_dna_version-null}" = "b" ]; \
		then \
			git checkout "tags/v${os_dna_version}" && \
			echo "${os_dna_version}" > "./version_installed"; \
		else \
			clone_latest_commit="$(git log -n 1 --pretty=format:"%H"  | cut -c1-7)" && \
			echo "bleeding-edge-${clone_latest_commit}" > "./version_installed"; \
		fi &> /dev/null \
	)

}

synthia-source_dna() {

	for f in /root/openspace42/dna/functions/*
	do
		. $f
	done

}

################################################################################

################################################################################
######################## Insert project functions here #########################
################################################################################

################################################################################
################################################################################
################################################################################

synthia-perform_installation() {

	############################################################################
	################### Add your install-time functions here ###################
	############################################################################

	dna-inception

	############################################################################
	############################################################################
	############################################################################

}

################################################################################
